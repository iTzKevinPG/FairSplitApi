generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  createdAt  DateTime  @default(now())
  verifiedAt DateTime?
  events     Event[]
}

model Event {
  id            String    @id @default(uuid())
  name          String
  currency      String
  owner         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId        String?
  participants  Person[]
  invoices      Invoice[]
  transferStatuses TransferStatus[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Person {
  id              String          @id @default(uuid())
  name            String
  event           Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId         String
  invoicesPaid    Invoice[]       @relation("InvoicePayer")
  participations  Participation[]
  itemAssignments InvoiceItemAssignment[]
  outgoingTransfers TransferStatus[] @relation("TransferFrom")
  incomingTransfers TransferStatus[] @relation("TransferTo")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Invoice {
  id                String          @id @default(uuid())
  description       String
  amount            Decimal         @db.Decimal(10, 2)
  divisionMethod    String
  tipAmount         Decimal?        @db.Decimal(10, 2)
  birthdayPersonId  String?
  consumptions      Json?
  items             InvoiceItem[]
  event             Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId           String
  payer             Person          @relation("InvoicePayer", fields: [payerId], references: [id], onDelete: Restrict)
  payerId           String
  participations    Participation[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model InvoiceItem {
  id          String                 @id @default(uuid())
  name        String
  unitPrice   Decimal                @db.Decimal(10, 2)
  quantity    Int
  total       Decimal                @db.Decimal(10, 2)
  invoice     Invoice                @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  assignments InvoiceItemAssignment[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@index([invoiceId])
}

model InvoiceItemAssignment {
  id        String      @id @default(uuid())
  item      InvoiceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId    String
  person    Person      @relation(fields: [personId], references: [id], onDelete: Restrict)
  personId  String
  amount    Decimal     @db.Decimal(10, 2)

  @@index([itemId])
  @@index([personId])
}

model Participation {
  id           String   @id @default(uuid())
  baseAmount   Decimal  @default(0) @db.Decimal(10, 2)
  tipShare     Decimal  @default(0) @db.Decimal(10, 2)
  finalAmount  Decimal  @default(0) @db.Decimal(10, 2)
  person       Person   @relation(fields: [personId], references: [id], onDelete: Restrict)
  personId     String
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId    String

  @@index([invoiceId])
  @@index([personId])
}

model TransferStatus {
  id                String   @id @default(uuid())
  event             Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId           String
  fromParticipant   Person   @relation("TransferFrom", fields: [fromParticipantId], references: [id], onDelete: Cascade)
  fromParticipantId String
  toParticipant     Person   @relation("TransferTo", fields: [toParticipantId], references: [id], onDelete: Cascade)
  toParticipantId   String
  isSettled         Boolean  @default(false)
  settledAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([eventId, fromParticipantId, toParticipantId])
  @@index([eventId])
}
